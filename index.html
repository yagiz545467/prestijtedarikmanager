<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prestij Tedarik - Dosya Yönetimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container-bg {
            background-color: #2d3748;
        }
        .card {
            background-color: #2d3748;
        }
        .item-list-container {
            min-height: 200px;
        }
        .file-item, .folder-item, .nav-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .file-item:hover, .folder-item:hover, .nav-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        .fade-out {
            animation: fadeOut 0.3s ease-in-out forwards;
        }
        .scale-in {
            animation: scaleIn 0.3s ease-in-out;
        }
        .slide-in-right {
            animation: slideInRight 0.5s ease-out forwards;
        }
        .slide-out-left {
            animation: slideOutLeft 0.5s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Login Screen -->
    <div id="login-container" class="card p-8 rounded-2xl shadow-lg w-full max-w-sm transition-all duration-300 transform scale-100">
        <h1 class="text-3xl font-bold text-center mb-6">Yönetici Girişi</h1>
        <form id="login-form" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium mb-1">Kullanıcı Adı</label>
                <input type="text" id="username" class="w-full p-2 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium mb-1">Şifre</label>
                <input type="password" id="password" class="w-full p-2 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
            </div>
            <button type="submit" class="w-full py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Giriş Yap</button>
            <p id="error-message" class="text-red-400 text-center text-sm mt-2 hidden"></p>
            <div id="debug-info" class="text-gray-400 text-sm mt-4 hidden">
                <p>Oluşturulan Hash:</p>
                <pre id="debug-hash" class="whitespace-pre-wrap break-all"></pre>
            </div>
        </form>
    </div>

    <!-- Main File Management Screen -->
    <div id="file-manager-container" class="container-bg p-8 rounded-2xl shadow-lg w-full max-w-4xl transition-all duration-300 opacity-0 hidden">
        <h1 class="text-3xl font-bold text-center mb-6">Prestij Tedarik - Dosya Yönetimi</h1>
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-2 md:space-y-0">
            <div id="breadcrumbs" class="text-sm text-gray-400">Ana Dizin</div>
            <div class="flex items-center space-x-2">
                <button id="new-folder-button" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Yeni Klasör</button>
                <input type="file" id="file-upload-input" class="hidden" accept=".txt">
                <button id="upload-file-button" class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Dosya Yükle</button>
                <button id="logout-button" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Çıkış Yap</button>
            </div>
        </div>
        <div id="main-content" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- File and Folder List -->
            <div id="file-list-pane" class="md:col-span-2 p-6 rounded-lg bg-gray-700 shadow-lg item-list-container">
                <h2 class="text-xl font-semibold mb-4">Dosyalar ve Klasörler</h2>
                <div id="file-list" class="space-y-2">
                    <!-- Files and folders will be added here -->
                </div>
            </div>
            <!-- File Content View -->
            <div id="file-content-pane" class="p-6 rounded-lg bg-gray-700 shadow-lg hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="file-content-title" class="text-xl font-semibold">Dosya İçeriği</h2>
                    <button id="back-button" class="py-1 px-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md transition-colors duration-200">Geri</button>
                </div>
                <pre id="file-content" class="bg-gray-800 p-4 rounded-lg text-sm whitespace-pre-wrap h-[400px] overflow-auto"></pre>
            </div>
        </div>
    </div>
    <!-- Message Box -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm text-center">
            <p id="message-text" class="text-white text-lg font-semibold mb-4"></p>
            <button id="message-ok-button" class="py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg">Tamam</button>
        </div>
    </div>
    
    <!-- Stock Data Script Block -->
    <script>
        // Normally in a separate file, the contents of stocks.js are here.
        // Since this environment supports a single-file structure, the data is directly within the HTML.
        const initialStocks = [
            { name: "Yönetim", type: "folder", parentPath: "" },
            { name: "Muhasebe", type: "folder", parentPath: "" },
            { name: "Pazarlama", type: "folder", parentPath: "" },
            { name: "Yazılım Geliştirme", type: "folder", parentPath: "" },
            { name: "Satış Raporu.txt", type: "file", content: "2024 yılı 1. çeyrek satış raporu.\n- Çelik: 120.000 ton\n- Boru: 85.000 ton\n- Profil: 45.000 ton", parentPath: "Yönetim" },
            { name: "Gider Tablosu.txt", type: "file", content: "Mart 2024 aylık giderler.\n- Ofis kirası: 15.000 TL\n- Personel maaşları: 85.000 TL\n- Pazarlama giderleri: 10.000 TL", parentPath: "Muhasebe" },
            { name: "Reklam Kampanyası.txt", type: "file", content: "Yeni ürün için sosyal medya reklam kampanyası planı.\n- Hedef kitle: İnşaat firmaları ve bireysel müteahhitler\n- Platformlar: Instagram, LinkedIn\n- Bütçe: 5.000 TL", parentPath: "Pazarlama" },
            { name: "Proje_Plan.txt", type: "file", content: "Yeni web sitesi için proje planı.\n- Modüller: Ürün kataloğu, sipariş takip, blog\n- Teknolojiler: React, Node.js, Firebase\n- Tahmini süre: 3 ay", parentPath: "Yazılım Geliştirme" },
            { name: "Vergi Beyannamesi.txt", type: "file", content: "2023 yılı vergi beyannamesi.\n- Kurumlar Vergisi\n- KDV Beyannamesi", parentPath: "Muhasebe" },
            { name: "Personel Listesi.txt", type: "file", content: "Müdür: Ali Yılmaz\nMüdür Yardımcısı: Ayşe Kara\nSatış Sorumlusu: Can Tekin", parentPath: "Yönetim" },
            { name: "SEO Raporu.txt", type: "file", content: "Web sitesi arama motoru optimizasyon (SEO) analizi.\n- Anahtar kelime sıralamaları\n- Geri bağlantı profili\n- Teknik SEO kontrolleri", parentPath: "Pazarlama" }
        ];
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, getDocs, addDoc, updateDoc, deleteDoc, where, doc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        
        // Enable detailed logging for Firebase.
        setLogLevel('debug');

        // This empty Firebase config object should be replaced with your own.
        // You can find your credentials in your Firebase project settings.
        const providedFirebaseConfig = {
            apiKey: "AIzaSyB9pwv47Ep7eCUIUCD5vSZL1R2Bw3EExKU",
            authDomain: "prestij-cd638.firebaseapp.com",
            projectId: "prestij-cd638",
            storageBucket: "prestij-cd638.firebasestorage.app",
            messagingSenderId: "282776622126",
            appId: "1:282776622126:web:b847191c620cc91fafbbbf",
            measurementId: "G-39S022X2QW"
        };

        // Global Firebase and Application Variables
        let db;
        let auth;
        let isAuthReady = false;
        let currentPath = ''; // Empty string for the root
        let pathHistory = [];

        // Security Credentials
        const _credentials = {
            user: "prestijtedarik",
            passHash: "72743a3ae2513268255e3279a2c3f9f1bf3b64e9cc1864fac7f0c65d119fc606"
        };
        
        // DOM Elements
        const loginContainer = document.getElementById('login-container');
        const fileManagerContainer = document.getElementById('file-manager-container');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const debugInfo = document.getElementById('debug-info');
        const debugHash = document.getElementById('debug-hash');
        const logoutButton = document.getElementById('logout-button');
        const fileListPane = document.getElementById('file-list-pane');
        const fileContentPane = document.getElementById('file-content-pane');
        const fileList = document.getElementById('file-list');
        const fileContent = document.getElementById('file-content');
        const fileContentTitle = document.getElementById('file-content-title');
        const backButton = document.getElementById('back-button');
        const uploadFileButton = document.getElementById('upload-file-button');
        const fileUploadInput = document.getElementById('file-upload-input');
        const newFolderButton = document.getElementById('new-folder-button');
        const breadcrumbs = document.getElementById('breadcrumbs');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkButton = document.getElementById('message-ok-button');

        // Firestore and Authentication Initialization
        window.onload = async () => {
            try {
                let firebaseConfig = null;
                if (typeof __firebase_config !== 'undefined') {
                    // Use environment variable
                    firebaseConfig = JSON.parse(__firebase_config);
                } else if (providedFirebaseConfig.projectId && providedFirebaseConfig.projectId !== "YOUR_PROJECT_ID") {
                    // Use user-provided configuration
                    firebaseConfig = providedFirebaseConfig;
                } else {
                    showMessage("Uygulama başlatılırken bir sorun oluştu: Firebase yapılandırması eksik.");
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        isAuthReady = true;
                        console.log("Firebase'e başarıyla bağlandı.");
                        await initializeDefaultData();
                    } else {
                        isAuthReady = false;
                        console.log("Firebase oturum açmadı.");
                    }
                });

                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Firebase'i başlatırken bir hata oluştu:", e);
                let message = "Veritabanına bağlanılamadı. Lütfen tekrar deneyin.";
                if (e.code === 'auth/configuration-not-found') {
                    message = "Kimlik Doğrulama hizmeti yapılandırma hatası. Lütfen Firebase projenizde 'Anonim Oturum Açma'nın etkinleştirildiğinden emin olun.";
                }
                showMessage(message);
            }
        };

        // Load default data when the application first starts
        async function initializeDefaultData() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const filesRef = collection(db, `artifacts/${appId}/public/data/files`);

            const docs = await getDocs(filesRef);
            if (docs.empty) {
                console.log("Veritabanı boş, varsayılan veriler yükleniyor...");
                // We use the stock data here
                for (const item of initialStocks) {
                    await addDoc(filesRef, item);
                }
            }
        }
        
        // SHA-256 Hash Function
        async function sha256(message) {
            const textAsBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', textAsBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hexHash;
        }
        
        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        messageOkButton.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // Listen to data from Firebase Firestore
        function listenToFileSystem() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const filesRef = collection(db, `artifacts/${appId}/public/data/files`);
            const q = query(filesRef, where('parentPath', '==', currentPath));

            onSnapshot(q, (querySnapshot) => {
                fileList.innerHTML = '';
                const items = [];
                querySnapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });

                items.sort((a, b) => {
                    if (a.type === 'folder' && b.type !== 'folder') return -1;
                    if (a.type !== 'folder' && b.type === 'folder') return 1;
                    return a.name.localeCompare(b.name);
                });

                if (currentPath !== '') {
                    const backItem = document.createElement('div');
                    backItem.classList.add('flex', 'items-center', 'p-3', 'rounded-lg', 'bg-gray-800', 'hover:bg-gray-700', 'transition-colors', 'duration-200', 'nav-item');
                    backItem.innerHTML = `<span class="text-xl mr-3">📁</span> <span class="font-semibold">.. (Geri)</span>`;
                    backItem.addEventListener('click', navigateUp);
                    fileList.appendChild(backItem);
                }

                items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('flex', 'items-center', 'justify-between', 'p-3', 'rounded-lg', 'bg-gray-800', 'hover:bg-gray-700', 'transition-colors', 'duration-200', 'file-item', 'scale-in');
                    
                    let icon = item.type === 'folder' ? '📁' : '📄';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.classList.add('font-semibold', 'flex-grow');
                    nameSpan.innerHTML = `<span class="text-xl mr-3">${icon}</span>${item.name}`;
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Sil';
                    deleteButton.classList.add('py-1', 'px-3', 'bg-red-500', 'hover:bg-red-600', 'text-white', 'font-semibold', 'rounded-md', 'transition-colors', 'duration-200');
                    deleteButton.setAttribute('data-id', item.id);
                    
                    itemElement.appendChild(nameSpan);
                    itemElement.appendChild(deleteButton);

                    if (item.type === 'folder') {
                        nameSpan.addEventListener('click', () => navigateInto(item.name));
                    } else {
                        nameSpan.addEventListener('click', () => showFileContent(item.content, item.name));
                    }
                    
                    fileList.appendChild(itemElement);
                });

                updateBreadcrumbs();
            }, (error) => {
                console.error("Veri alınırken hata oluştu:", error);
                // Don't show an error message, as onSnapshot works even with temporary errors.
            });
        }

        function navigateInto(folderName) {
            pathHistory.push(folderName);
            currentPath = pathHistory.join('/');
            listenToFileSystem();
        }

        function navigateUp() {
            pathHistory.pop();
            currentPath = pathHistory.length === 0 ? '' : pathHistory.join('/');
            listenToFileSystem();
        }

        function showFileContent(content, fileName) {
            fileContentTitle.textContent = fileName;
            fileContent.textContent = content;

            fileListPane.classList.remove('slide-in-right');
            fileListPane.classList.add('slide-out-left');
            fileListPane.addEventListener('animationend', () => {
                fileListPane.classList.add('hidden');
                fileListPane.classList.remove('slide-out-left');
                
                fileContentPane.classList.remove('hidden');
                fileContentPane.classList.add('slide-in-right');
            }, { once: true });
        }

        backButton.addEventListener('click', () => {
            fileContentPane.classList.remove('slide-in-right');
            fileContentPane.classList.add('slide-out-left');
            fileContentPane.addEventListener('animationend', () => {
                fileContentPane.classList.add('hidden');
                fileContentPane.classList.remove('slide-out-left');
                
                fileListPane.classList.remove('hidden');
                fileListPane.classList.add('slide-in-right');
            }, { once: true });
        });

        function updateBreadcrumbs() {
            let path = 'Ana Dizin';
            if (pathHistory.length > 0) {
                path += ' / ' + pathHistory.join(' / ');
            }
            breadcrumbs.textContent = path;
        }

        passwordInput.addEventListener('input', async (e) => {
            const typedPassword = e.target.value.trim();
            if (typedPassword.length > 0) {
                const typedHash = await sha256(typedPassword);
                debugHash.textContent = typedHash;
                debugInfo.classList.remove('hidden');
            } else {
                debugInfo.classList.add('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value.trim();
            
            const hashedPassword = await sha256(password);
            
            if (username === _credentials.user && hashedPassword === _credentials.passHash) {
                loginContainer.classList.add('hidden');
                fileManagerContainer.classList.remove('hidden');
                fileManagerContainer.classList.add('opacity-100', 'fade-in');
                listenToFileSystem();
            } else {
                errorMessage.textContent = 'Hatalı kullanıcı adı veya şifre.';
                errorMessage.classList.remove('hidden');
            }
        });

        logoutButton.addEventListener('click', () => {
            fileManagerContainer.classList.add('hidden');
            fileManagerContainer.classList.remove('opacity-100');
            loginContainer.classList.remove('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
            errorMessage.classList.add('hidden');
            currentPath = '';
            pathHistory = [];
            updateBreadcrumbs();
        });

        uploadFileButton.addEventListener('click', () => {
            fileUploadInput.click();
        });

        fileUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                const fileName = file.name;
                
                if (!isAuthReady) {
                    showMessage("Kimlik doğrulaması henüz tamamlanmadı. Lütfen bekleyip tekrar deneyin.");
                    return;
                }

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const filesRef = collection(db, `artifacts/${appId}/public/data/files`);
                    await addDoc(filesRef, {
                        name: fileName,
                        type: 'file',
                        content: content,
                        parentPath: currentPath,
                        createdAt: new Date()
                    });
                    showMessage(`"${fileName}" başarıyla yüklendi.`);
                } catch (e) {
                    console.error("Dosya yüklenirken hata oluştu:", e);
                    showMessage("Dosya yüklenemedi. Lütfen tekrar deneyin.");
                }
            };
            reader.readAsText(file);
        });

        newFolderButton.addEventListener('click', async () => {
            const folderName = prompt("Yeni klasör için bir isim girin:");
            if (folderName && folderName.trim() !== '') {
                if (!isAuthReady) {
                    showMessage("Kimlik doğrulaması henüz tamamlanmadı. Lütfen bekleyip tekrar deneyin.");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const filesRef = collection(db, `artifacts/${appId}/public/data/files`);
                    await addDoc(filesRef, {
                        name: folderName,
                        type: 'folder',
                        parentPath: currentPath,
                        createdAt: new Date()
                    });
                    showMessage(`"${folderName}" klasörü oluşturuldu.`);
                } catch (e) {
                    console.error("Klasör oluşturulurken hata oluştu:", e);
                    showMessage("Klasör oluşturulamadı. Lütfen tekrar deneyin.");
                }
            }
        });

        fileList.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('button');
            if (deleteButton && deleteButton.textContent === 'Sil') {
                const docId = deleteButton.getAttribute('data-id');
                const itemName = deleteButton.previousElementSibling.textContent.trim().replace(/^. /, '');
                if (!isAuthReady) {
                    showMessage("Kimlik doğrulaması henüz tamamlanmadı. Lütfen bekleyip tekrar deneyin.");
                    return;
                }
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/files`, docId));
                    showMessage(`"${itemName}" başarıyla silindi.`);
                } catch (e) {
                    console.error("Öğe silinirken hata oluştu:", e);
                    showMessage("Öğe silinemedi. Lütfen tekrar deneyin.");
                }
            }
        });
    </script>
</body>
</html>
