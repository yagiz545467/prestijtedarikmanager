<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prestij Tedarik - Dosya Y√∂netimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container-bg {
            background-color: #2d3748;
        }
        .card {
            background-color: #2d3748;
        }
        .item-list-container {
            min-height: 200px;
        }
        .file-item, .folder-item, .nav-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .file-item:hover, .folder-item:hover, .nav-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out forwards;
        }
        .fade-out {
            animation: fadeOut 0.3s ease-in-out forwards;
        }
        .scale-in {
            animation: scaleIn 0.3s ease-in-out;
        }
        .slide-in-right {
            animation: slideInRight 0.5s ease-out forwards;
        }
        .slide-out-left {
            animation: slideOutLeft 0.5s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Login Ekranƒ± -->
    <div id="login-container" class="card p-8 rounded-2xl shadow-lg w-full max-w-sm transition-all duration-300 transform scale-100">
        <h1 class="text-3xl font-bold text-center mb-6">Y√∂netici Giri≈üi</h1>
        <form id="login-form" class="space-y-4">
            <div>
                <label for="username" class="block text-sm font-medium mb-1">Kullanƒ±cƒ± Adƒ±</label>
                <input type="text" id="username" class="w-full p-2 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
            </div>
            <div>
                <label for="password" class="block text-sm font-medium mb-1">≈ûifre</label>
                <input type="password" id="password" class="w-full p-2 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
            </div>
            <button type="submit" class="w-full py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Giri≈ü Yap</button>
            <p id="error-message" class="text-red-400 text-center text-sm mt-2 hidden"></p>
            <div id="debug-info" class="text-gray-400 text-sm mt-4 hidden">
                <p>Olu≈üturulan Hash:</p>
                <pre id="debug-hash" class="whitespace-pre-wrap break-all"></pre>
            </div>
        </form>
    </div>

    <!-- Ana Dosya Y√∂netim Ekranƒ± -->
    <div id="file-manager-container" class="container-bg p-8 rounded-2xl shadow-lg w-full max-w-4xl transition-all duration-300 opacity-0 hidden">
        <h1 class="text-3xl font-bold text-center mb-6">Prestij Tedarik - Dosya Y√∂netimi</h1>

        <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-2 md:space-y-0">
            <div id="breadcrumbs" class="text-sm text-gray-400">Ana Dizin</div>
            <div class="flex items-center space-x-2">
                <button id="new-folder-button" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Yeni Klas√∂r</button>
                <input type="file" id="file-upload-input" class="hidden" accept=".txt">
                <button id="upload-file-button" class="py-2 px-4 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">Dosya Y√ºkle</button>
                <button id="logout-button" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">√áƒ±kƒ±≈ü Yap</button>
            </div>
        </div>

        <div id="main-content" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Dosya ve Klas√∂r Listesi -->
            <div id="file-list-pane" class="md:col-span-2 p-6 rounded-lg bg-gray-700 shadow-lg item-list-container">
                <h2 class="text-xl font-semibold mb-4">Dosyalar ve Klas√∂rler</h2>
                <div id="file-list" class="space-y-2">
                    <!-- Dosyalar ve Klas√∂rler buraya eklenecek -->
                </div>
            </div>

            <!-- Dosya ƒ∞√ßerik G√∂r√ºnt√ºleme -->
            <div id="file-content-pane" class="p-6 rounded-lg bg-gray-700 shadow-lg hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="file-content-title" class="text-xl font-semibold">Dosya ƒ∞√ßeriƒüi</h2>
                    <button id="back-button" class="py-1 px-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-md transition-colors duration-200">Geri</button>
                </div>
                <pre id="file-content" class="bg-gray-800 p-4 rounded-lg text-sm whitespace-pre-wrap h-[400px] overflow-auto"></pre>
            </div>
        </div>
    </div>

    <!-- Mesaj Kutusu -->
    <div id="message-box" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-sm text-center">
            <p id="message-text" class="text-white text-lg font-semibold mb-4"></p>
            <button id="message-ok-button" class="py-2 px-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg">Tamam</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, getDoc, doc, addDoc, updateDoc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase ve Uygulama Deƒüi≈ükenleri
        let db;
        let auth;
        let currentPath = '/';
        let pathHistory = [];

        // G√ºvenlik Kimlik Bilgileri
        const _credentials = {
            user: "prestijtedarik",
            passHash: "72743a3ae2513268255e3279a2c3f9f1bf3b64e9cc1864fac7f0c65d119fc606"
        };
        
        // DOM Elementleri
        const loginContainer = document.getElementById('login-container');
        const fileManagerContainer = document.getElementById('file-manager-container');
        const loginForm = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const debugInfo = document.getElementById('debug-info');
        const debugHash = document.getElementById('debug-hash');
        const logoutButton = document.getElementById('logout-button');
        const fileListPane = document.getElementById('file-list-pane');
        const fileContentPane = document.getElementById('file-content-pane');
        const fileList = document.getElementById('file-list');
        const fileContent = document.getElementById('file-content');
        const fileContentTitle = document.getElementById('file-content-title');
        const backButton = document.getElementById('back-button');
        const uploadFileButton = document.getElementById('upload-file-button');
        const fileUploadInput = document.getElementById('file-upload-input');
        const newFolderButton = document.getElementById('new-folder-button');
        const breadcrumbs = document.getElementById('breadcrumbs');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageOkButton = document.getElementById('message-ok-button');

        // Firestore ve Kimlik Doƒürulama
        window.onload = async () => {
            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // onAuthStateChanged ile oturum durumunu dinle
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Firebase'e ba≈üarƒ±lƒ± bir ≈üekilde baƒülandƒ±.");
                        // Giri≈ü yapƒ±ldƒ±ysa dosya listesini dinle
                        listenToFileSystem();
                    } else {
                        console.log("Firebase oturum a√ßmadƒ±.");
                    }
                });

            } catch (e) {
                console.error("Firebase'i ba≈ülatƒ±rken bir hata olu≈ütu:", e);
                showMessage("Veritabanƒ±na baƒülanƒ±lamadƒ±. L√ºtfen tekrar deneyin.");
            }
        };

        // SHA-256 Hash Fonksiyonu
        async function sha256(message) {
            const textAsBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', textAsBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hexHash;
        }
        
        // Mesaj Kutusu G√∂ster
        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }

        // Mesaj Kutusu Kapat
        messageOkButton.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // Firebase Firestore'dan verileri dinle
        function listenToFileSystem() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const filesRef = collection(db, `artifacts/${appId}/public/data/files`);
            const q = query(filesRef, where('parentPath', '==', currentPath));

            onSnapshot(q, (querySnapshot) => {
                fileList.innerHTML = '';
                const items = [];
                querySnapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });

                // √ñnce klas√∂rleri, sonra dosyalarƒ± sƒ±rala
                items.sort((a, b) => {
                    if (a.type === 'folder' && b.type !== 'folder') return -1;
                    if (a.type !== 'folder' && b.type === 'folder') return 1;
                    return a.name.localeCompare(b.name);
                });

                // Geri butonu
                if (currentPath !== '/') {
                    const backItem = document.createElement('div');
                    backItem.classList.add('flex', 'items-center', 'p-3', 'rounded-lg', 'bg-gray-800', 'hover:bg-gray-700', 'transition-colors', 'duration-200', 'nav-item');
                    backItem.innerHTML = `<span class="text-xl mr-3">üìÅ</span> <span class="font-semibold">.. (Geri)</span>`;
                    backItem.addEventListener('click', navigateUp);
                    fileList.appendChild(backItem);
                }

                // Dosya ve klas√∂rleri listele
                items.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('flex', 'items-center', 'justify-between', 'p-3', 'rounded-lg', 'bg-gray-800', 'hover:bg-gray-700', 'transition-colors', 'duration-200', 'file-item', 'scale-in');
                    
                    let icon = item.type === 'folder' ? 'üìÅ' : 'üìÑ';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.classList.add('font-semibold', 'flex-grow');
                    nameSpan.innerHTML = `<span class="text-xl mr-3">${icon}</span>${item.name}`;
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Sil';
                    deleteButton.classList.add('py-1', 'px-3', 'bg-red-500', 'hover:bg-red-600', 'text-white', 'font-semibold', 'rounded-md', 'transition-colors', 'duration-200');
                    deleteButton.setAttribute('data-id', item.id);
                    
                    itemElement.appendChild(nameSpan);
                    itemElement.appendChild(deleteButton);

                    if (item.type === 'folder') {
                        nameSpan.addEventListener('click', () => navigateInto(item.name));
                    } else {
                        nameSpan.addEventListener('click', () => showFileContent(item.content, item.name));
                    }
                    
                    fileList.appendChild(itemElement);
                });

                updateBreadcrumbs();
            }, (error) => {
                console.error("Veri alƒ±nƒ±rken hata olu≈ütu:", error);
                showMessage("Dosyalara eri≈üilemiyor. L√ºtfen tekrar deneyin.");
            });
        }

        async function navigateInto(folderName) {
            pathHistory.push(folderName);
            currentPath = pathHistory.join('/');
            listenToFileSystem();
        }

        async function navigateUp() {
            pathHistory.pop();
            currentPath = pathHistory.length === 0 ? '/' : pathHistory.join('/');
            listenToFileSystem();
        }

        function showFileContent(content, fileName) {
            fileContentTitle.textContent = fileName;
            fileContent.textContent = content;

            fileListPane.classList.add('slide-out-left');
            fileListPane.addEventListener('animationend', () => {
                fileListPane.classList.add('hidden');
                fileListPane.classList.remove('slide-out-left');
                
                fileContentPane.classList.remove('hidden');
                fileContentPane.classList.add('slide-in-right');
            }, { once: true });
        }
        
        backButton.addEventListener('click', () => {
            fileContentPane.classList.remove('slide-in-right');
            fileContentPane.classList.add('slide-out-left');
            fileContentPane.addEventListener('animationend', () => {
                fileContentPane.classList.add('hidden');
                fileContentPane.classList.remove('slide-out-left');
                
                fileListPane.classList.remove('hidden');
                fileListPane.classList.add('slide-in-right');
            }, { once: true });
        });

        function updateBreadcrumbs() {
            let path = 'Ana Dizin';
            if (pathHistory.length > 0) {
                path += ' / ' + pathHistory.join(' / ');
            }
            breadcrumbs.textContent = path;
        }

        // ≈ûifre alanƒ±na bir ≈üey yazƒ±ldƒ±ƒüƒ±nda hash'i g√∂ster
        passwordInput.addEventListener('input', async (e) => {
            const typedPassword = e.target.value.trim();
            if (typedPassword.length > 0) {
                const typedHash = await sha256(typedPassword);
                debugHash.textContent = typedHash;
                debugInfo.classList.remove('hidden');
            } else {
                debugInfo.classList.add('hidden');
            }
        });

        // Login i≈ülemi
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const password = passwordInput.value.trim();
            
            const hashedPassword = await sha256(password);
            
            if (username === _credentials.user && hashedPassword === _credentials.passHash) {
                loginContainer.classList.add('hidden');
                fileManagerContainer.classList.remove('hidden');
                fileManagerContainer.classList.add('opacity-100', 'fade-in');
            } else {
                errorMessage.textContent = 'Hatalƒ± kullanƒ±cƒ± adƒ± veya ≈üifre.';
                errorMessage.classList.remove('hidden');
            }
        });

        // √áƒ±kƒ±≈ü i≈ülemi
        logoutButton.addEventListener('click', () => {
            fileManagerContainer.classList.add('hidden');
            fileManagerContainer.classList.remove('opacity-100');
            loginContainer.classList.remove('hidden');
            usernameInput.value = '';
            passwordInput.value = '';
            errorMessage.classList.add('hidden');
            currentPath = '/';
            pathHistory = [];
            updateBreadcrumbs();
        });

        // Dosya y√ºkleme
        uploadFileButton.addEventListener('click', () => {
            fileUploadInput.click();
        });

        fileUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                const fileName = file.name;

                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const filesRef = collection(db, `artifacts/${appId}/public/data/files`);
                    await addDoc(filesRef, {
                        name: fileName,
                        type: 'file',
                        content: content,
                        parentPath: currentPath,
                        createdAt: new Date()
                    });
                    showMessage(`"${fileName}" ba≈üarƒ±yla y√ºklendi.`);
                } catch (e) {
                    console.error("Dosya y√ºklenirken hata olu≈ütu:", e);
                    showMessage("Dosya y√ºklenemedi. L√ºtfen tekrar deneyin.");
                }
            };
            reader.readAsText(file);
        });

        // Yeni klas√∂r olu≈üturma
        newFolderButton.addEventListener('click', async () => {
            const folderName = prompt("Yeni klas√∂r i√ßin bir isim girin:");
            if (folderName && folderName.trim() !== '') {
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const filesRef = collection(db, `artifacts/${appId}/public/data/files`);
                    await addDoc(filesRef, {
                        name: folderName,
                        type: 'folder',
                        parentPath: currentPath,
                        createdAt: new Date()
                    });
                    showMessage(`"${folderName}" klas√∂r√º olu≈üturuldu.`);
                } catch (e) {
                    console.error("Klas√∂r olu≈üturulurken hata olu≈ütu:", e);
                    showMessage("Klas√∂r olu≈üturulamadƒ±. L√ºtfen tekrar deneyin.");
                }
            }
        });

        // Silme i≈ülemi i√ßin olay delegasyonu
        fileList.addEventListener('click', async (e) => {
            const deleteButton = e.target.closest('button');
            if (deleteButton && deleteButton.textContent === 'Sil') {
                const docId = deleteButton.getAttribute('data-id');
                const itemName = deleteButton.previousElementSibling.textContent.trim().replace(/^. /, ''); // ƒ∞konu √ßƒ±kar
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/files`, docId));
                    showMessage(`"${itemName}" ba≈üarƒ±yla silindi.`);
                } catch (e) {
                    console.error("√ñƒüe silinirken hata olu≈ütu:", e);
                    showMessage("√ñƒüe silinemedi. L√ºtfen tekrar deneyin.");
                }
            }
        });
    </script>
</body>
</html>
